"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var r=0,t=Array(e.length);r<e.length;r++)t[r]=e[r];return t}return Array.from(e)}function _classCallCheck(e,r){if(!(e instanceof r))throw new TypeError("Cannot call a class as a function")}Object.defineProperty(exports,"__esModule",{value:!0});var _createClass=function(){function e(e,r){for(var t=0;t<r.length;t++){var o=r[t];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(r,t,o){return t&&e(r.prototype,t),o&&e(r,o),r}}(),Mochila=function(){function e(){_classCallCheck(this,e),this._store={},this._factories={}}return _createClass(e,[{key:"clearCollections",value:function(){for(var e in this._store)this._store.hasOwnProperty(e)&&"object"==typeof this._store[e]&&(this._store[e].length=0)}},{key:"addCollection",value:function(e){if(void 0!==this._store[e])throw new Error('A Mochila collection named "'+e+'" already exists! Cannot add it again.');this._store[e]=[]}},{key:"hasCollection",value:function(e){return!!this._store[e]}},{key:"collectionNames",value:function(){return Object.keys(this._store)}},{key:"clearFactories",value:function(){for(var e in this._factories)this._factories.hasOwnProperty(e)&&delete this._factories[e]}},{key:"removeFactory",value:function(e){this._factories.hasOwnProperty(e)&&delete this._factories[e]}},{key:"addFactory",value:function(e,r){if(void 0===this._store[e])throw new Error('There is no collection named "'+e+'" in the mochila!');if(void 0!==this._factories[e])throw new Error('There is already a registered model factory for the collection named "'+e+'" in the mochila!');if("function"!=typeof r||"function"!=typeof r.create)throw new Error('The model factory for the mochila collection named "'+e+'" you are trying to register is not of the proper datatype!');this._factories[e]=r}},{key:"createModelOfType",value:function(e){for(var r,t=this._factories[e],o=arguments.length,n=Array(o>1?o-1:0),i=1;o>i;i++)n[i-1]=arguments[i];return t?r=t.create.apply(t,n):(r={},this._mergeObject.apply(this,_toConsumableArray([r].concat(n)))),r}},{key:"load",value:function(e,r){var t=this,o=this._store[e],n=this._factories[e];if(void 0===o)throw new Error("There is no collection named "+e+" in the mochila!");if("string"==typeof r)try{r=JSON.parse(r)}catch(i){throw new Error("Mochila tried to parse the string you loaded, but it was not JSON!")}if("object"!=typeof r)throw new Error("Payload for the mochila collection named "+e+" was not an object!");Array.isArray(r)||(r=[r]),0!==r.length&&(r=r.map(function(r){return n&&r instanceof n?r:t.createModelOfType(e,r)}),this._pushModels(o,r))}},{key:"_mergeObject",value:function(e){function r(e){var t,o,n;if(Array.isArray(e))for(n=[],t=0;t<e.length;++t)n.push(r(e[t]));else if("object"==typeof e){n={};for(o in e)e.hasOwnProperty(o)&&(n[o]=r(e[o]))}else n=e;return n}var t,o,n;if("object"==typeof e&&!Array.isArray(e)){for(var i=arguments.length,a=Array(i>1?i-1:0),s=1;i>s;s++)a[s-1]=arguments[s];for(t=0;t<a.length;++t)if(n=a[t],"object"==typeof n&&!Array.isArray(n))for(o in n)n.hasOwnProperty(o)&&(e[o]=r(n[o]))}}},{key:"_pushModels",value:function(e,r){var t,o=this;if("object"!=typeof r)throw new Error("Model to be pushed into the mochila collection named "+e+" was not an object or an array!",r);Array.isArray(r)||(r=[r]),t="string"==typeof type?this._store[e]:e,r.forEach(function(e){var r,n;r=o._binarySearch(t,e.id),r?o._mergeObject(r,e):(n=o._getInsertIndex(t,e.id),t.splice(n,0,e))})}},{key:"_getInsertIndex",value:function(e,r,t){if(t=t||"id",void 0===r)throw new Error("Mochila: The value for getting insert index was undefined!");if(0===e.length)return 0;if(typeof e[0][t]!=typeof r)throw new Error('Mochila: The value for getting insert index, "'+r+'" was not of the same type as that held by object key, "'+t+'"!');for(var o,n,i=0,a=e.length-1;a>=i;)o=i+Math.floor((a-i)/2),n=e[o],r<n[t]?a=o-1:i=o+1;return a+1}},{key:"_binarySearch",value:function(e,r,t){var o=this._binarySearchIndex(e,r,t);return o&&(o=o.sortedArray[o.idx]),o}},{key:"_binarySearchIndex",value:function(e,r,t){if(t=t||"id",void 0===r)throw new Error("Mochila: The value for binary searching (for index) was undefined!");if(0!==e.length&&typeof e[0][t]==typeof r){for(var o,n,i=0,a=e.length-1;a>=i;)if(o=i+Math.floor((a-i)/2),n=e[o],n[t]<r)i=o+1;else{if(!(r<n[t]))return{sortedArray:e,idx:o};a=o-1}return{sortedArray:e,idx:void 0}}}},{key:"sortBy",value:function(e,r){var t;if(r=r||"id","string"!=typeof e)throw new Error('Mochila tried to sort a collection by key "'+r+'" but was not passed the name of the collection!');return t=this._store[e].slice(),t.length&&"id"!==r&&t.sort("number"==typeof t[0][r]?function(e,t){return e[r]-t[r]}:function(e,t){var o=e[r],n=t[r];return n>o?-1:o>n?1:0}),t}},{key:"all",value:function(e,r,t){var o,n=this._store[e];if(!n)throw new Error('There is no collection named "'+e+'" in the mochila!');return void 0===t?void 0===r?n.slice():(o=this._binarySearch(n,r),o?[o]:[]):n.filter(function(e){return e[r]===t})}},{key:"find",value:function(e,r,t){var o=this._store[e];if(!o)throw new Error('There is no collection named "'+e+'" in the mochila!');return void 0===t?this._binarySearch(o,r):o.find(function(e){return e[r]===t})}},{key:"removeModels",value:function(e,r){var t,o,n=this._store[e],i=[];if(!n)throw new Error('There is no collection named "'+e+'" in the mochila!');if("object"!=typeof r)throw new Error("Mochila: Argument passed to deleteModel() was neither an object nor an array!");for(Array.isArray(r)||(r=[r]),t=0;t<r.length;++t)o=this._binarySearchIndex(n,r[t].id).idx,void 0!==o&&i.push(n.splice(o,1)[0]);return i}},{key:"removeWhere",value:function(e,r,t){if(void 0===r&&void 0===t)throw new Error("Mochila cannot removeWhere() without a value given! If you want to clear all models, use clear() instead.");var o=this.all(e,r,t);return this.removeModels(e,o)}}]),e}();exports["default"]=Mochila,module.exports=exports["default"];